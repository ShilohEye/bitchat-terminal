# Test-specific Dockerfile for bitchat-terminal with dependency caching
FROM rust:1.85-bookworm

# Install build dependencies for Bluetooth Low Energy support and testing
RUN apt-get update && apt-get install -y \
    pkg-config \
    libdbus-1-dev \
    libbluetooth-dev \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy dependency files first for caching
COPY Cargo.toml Cargo.lock ./

# Create a dummy main.rs to satisfy cargo build
RUN mkdir src && echo "fn main() {}" > src/main.rs

# Build dependencies (this layer will be cached)
RUN cargo build --release && rm -rf src target/release/deps/bitchat*

# Copy actual source code
COPY src ./src

# Set RUSTFLAGS to suppress dead_code warnings during tests
ENV RUSTFLAGS="-A dead_code"

# Run tests by default
CMD ["cargo", "test", "--release"]